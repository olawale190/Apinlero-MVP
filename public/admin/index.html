<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isha Treat Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2E7D32;
      --primary-light: #4CAF50;
      --primary-dark: #1B5E20;
    }
    body { background-color: #f5f5f5; }
    .sidebar {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      min-height: 100vh;
      color: white;
    }
    .sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 12px 20px;
      border-radius: 8px;
      margin: 4px 8px;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      background: rgba(255,255,255,0.15);
      color: white;
    }
    .sidebar .nav-link i { margin-right: 10px; }
    .brand { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .brand h4 { margin: 0; font-weight: 700; }
    .main-content { padding: 30px; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-header { background: white; border-bottom: 1px solid #eee; font-weight: 600; }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
    .btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); }
    .btn-outline-primary:hover { background-color: var(--primary-color); border-color: var(--primary-color); }
    .stat-card { padding: 20px; text-align: center; }
    .stat-card .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
    .stat-card .stat-label { color: #666; font-size: 0.9rem; }
    .product-image { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    .product-image-preview { max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px; }
    .login-container { max-width: 400px; margin: 100px auto; }
    .upload-zone {
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary-color); background: #f8fff8; }
    .image-preview-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .image-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
    }
    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    .image-preview-item .remove-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
    }
    .table th { font-weight: 600; color: #555; }
    .badge-stock-low { background-color: #fff3cd; color: #856404; }
    .badge-stock-ok { background-color: #d4edda; color: #155724; }
    #app { display: none; }
    #loginPage { display: block; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container"></div>

  <!-- Login Page -->
  <div id="loginPage">
    <div class="login-container">
      <div class="card">
        <div class="card-body p-4">
          <div class="text-center mb-4">
            <h3 class="text-success fw-bold">Isha Treat</h3>
            <p class="text-muted">Admin Panel</p>
          </div>
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="loginBtn">
              <span class="spinner-border spinner-border-sm d-none" id="loginSpinner"></span>
              Login
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app">
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
          <div class="brand">
            <h4><i class="bi bi-shop"></i> Isha Treat</h4>
            <small>Admin Panel</small>
          </div>
          <nav class="nav flex-column mt-3">
            <a class="nav-link active" href="#" data-page="dashboard">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a class="nav-link" href="#" data-page="categories">
              <i class="bi bi-grid"></i> Categories
            </a>
            <a class="nav-link" href="#" data-page="products">
              <i class="bi bi-box-seam"></i> Products
            </a>
            <a class="nav-link" href="#" data-page="orders">
              <i class="bi bi-receipt"></i> Orders
            </a>
            <a class="nav-link mt-4" href="#" id="logoutBtn">
              <i class="bi bi-box-arrow-left"></i> Logout
            </a>
          </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 main-content">
          <!-- Dashboard Page -->
          <div id="dashboardPage" class="page">
            <h4 class="mb-4">Dashboard</h4>
            <div class="row g-4" id="statsGrid">
              <!-- Stats loaded dynamically -->
            </div>
          </div>

          <!-- Categories Page -->
          <div id="categoriesPage" class="page d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">Categories</h4>
              <button class="btn btn-primary" onclick="showCategoryModal()">
                <i class="bi bi-plus-lg"></i> Add Category
              </button>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table" id="categoriesTable">
                    <thead>
                      <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Products</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Products Page -->
          <div id="productsPage" class="page d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">Products</h4>
              <button class="btn btn-primary" onclick="showProductModal()">
                <i class="bi bi-plus-lg"></i> Add Product
              </button>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-4">
                    <select class="form-select" id="productCategoryFilter" onchange="loadProducts()">
                      <option value="">All Categories</option>
                    </select>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table" id="productsTable">
                    <thead>
                      <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Orders Page -->
          <div id="ordersPage" class="page d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="mb-0">Orders</h4>
              <select class="form-select w-auto" id="orderStatusFilter" onchange="loadOrders()">
                <option value="">All Status</option>
                <option value="PENDING">Pending</option>
                <option value="CONFIRMED">Confirmed</option>
                <option value="PROCESSING">Processing</option>
                <option value="SHIPPED">Shipped</option>
                <option value="DELIVERED">Delivered</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table" id="ordersTable">
                    <thead>
                      <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Modal -->
  <div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="categoryForm">
          <div class="modal-body">
            <input type="hidden" id="categoryId">
            <div class="mb-3">
              <label class="form-label">Name *</label>
              <input type="text" class="form-control" id="categoryName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Image</label>
              <div class="upload-zone" id="categoryUploadZone" onclick="document.getElementById('categoryImageInput').click()">
                <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                <p class="mb-0 text-muted">Click or drag image here</p>
              </div>
              <input type="file" id="categoryImageInput" class="d-none" accept="image/*" onchange="handleCategoryImage(this)">
              <div id="categoryImagePreview" class="mt-3 text-center d-none">
                <img src="" class="product-image-preview">
                <br>
                <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeCategoryImage()">Remove</button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveCategoryBtn">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productModalTitle">Add Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="productForm">
          <div class="modal-body">
            <input type="hidden" id="productId">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Name *</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Category *</label>
                <select class="form-select" id="productCategory" required>
                  <option value="">Select Category</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="productDescription" rows="2"></textarea>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">Price *</label>
                <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Compare Price</label>
                <input type="number" class="form-control" id="productComparePrice" min="0" step="0.01">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Unit *</label>
                <input type="text" class="form-control" id="productUnit" placeholder="e.g., kg, bag, piece" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Stock *</label>
                <input type="number" class="form-control" id="productStock" min="0" value="0" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="productStatus">
                  <option value="true">Active</option>
                  <option value="false">Inactive</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Product Images</label>
              <div class="upload-zone" id="productUploadZone" onclick="document.getElementById('productImageInput').click()">
                <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                <p class="mb-0 text-muted">Click or drag images here (max 5)</p>
              </div>
              <input type="file" id="productImageInput" class="d-none" accept="image/*" multiple onchange="handleProductImages(this)">
              <div id="productImagesPreview" class="image-preview-grid"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveProductBtn">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Order Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="orderDetails">
          <!-- Order details loaded dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Configuration
    const API_BASE = '/api';
    let accessToken = localStorage.getItem('adminToken');
    let productImages = [];
    let categoryImageUrl = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      if (accessToken) {
        showApp();
      }
      setupEventListeners();
    });

    function setupEventListeners() {
      // Login form
      document.getElementById('loginForm').addEventListener('submit', handleLogin);

      // Navigation
      document.querySelectorAll('.nav-link[data-page]').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          navigateTo(this.dataset.page);
        });
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);

      // Category form
      document.getElementById('categoryForm').addEventListener('submit', handleCategorySubmit);

      // Product form
      document.getElementById('productForm').addEventListener('submit', handleProductSubmit);

      // Drag and drop for upload zones
      setupDragDrop('categoryUploadZone', 'categoryImageInput');
      setupDragDrop('productUploadZone', 'productImageInput');
    }

    function setupDragDrop(zoneId, inputId) {
      const zone = document.getElementById(zoneId);
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
        zone.addEventListener(event, e => { e.preventDefault(); e.stopPropagation(); });
      });
      ['dragenter', 'dragover'].forEach(event => {
        zone.addEventListener(event, () => zone.classList.add('dragover'));
      });
      ['dragleave', 'drop'].forEach(event => {
        zone.addEventListener(event, () => zone.classList.remove('dragover'));
      });
      zone.addEventListener('drop', e => {
        const input = document.getElementById(inputId);
        input.files = e.dataTransfer.files;
        input.dispatchEvent(new Event('change'));
      });
    }

    // API Helper
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json' };
      if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;

      const response = await fetch(API_BASE + endpoint, {
        ...options,
        headers: { ...headers, ...options.headers }
      });

      if (response.status === 401) {
        handleLogout();
        throw new Error('Session expired');
      }

      const data = await response.json();
      if (!response.ok) throw new Error(data.message || 'Request failed');
      return data;
    }

    async function uploadImage(file, folder = 'products') {
      const formData = new FormData();
      formData.append('image', file);

      const response = await fetch(`${API_BASE}/upload/image?folder=${folder}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${accessToken}` },
        body: formData
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.message || 'Upload failed');
      }

      return response.json();
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const container = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0 show`;
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Auth
    async function handleLogin(e) {
      e.preventDefault();
      const btn = document.getElementById('loginBtn');
      const spinner = document.getElementById('loginSpinner');

      btn.disabled = true;
      spinner.classList.remove('d-none');

      try {
        const data = await api('/auth/login', {
          method: 'POST',
          body: JSON.stringify({
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value
          })
        });

        if (data.data.user.role !== 'ADMIN') {
          throw new Error('Admin access required');
        }

        accessToken = data.data.accessToken;
        localStorage.setItem('adminToken', accessToken);
        showApp();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
      }
    }

    function handleLogout() {
      accessToken = null;
      localStorage.removeItem('adminToken');
      document.getElementById('app').style.display = 'none';
      document.getElementById('loginPage').style.display = 'block';
    }

    function showApp() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      loadDashboard();
    }

    // Navigation
    function navigateTo(page) {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      document.querySelectorAll('.page').forEach(p => p.classList.add('d-none'));
      document.getElementById(`${page}Page`).classList.remove('d-none');

      switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'categories': loadCategories(); break;
        case 'products': loadProducts(); break;
        case 'orders': loadOrders(); break;
      }
    }

    // Dashboard
    async function loadDashboard() {
      try {
        const { data } = await api('/admin/dashboard');
        document.getElementById('statsGrid').innerHTML = `
          <div class="col-md-3">
            <div class="card stat-card">
              <div class="stat-value">${data.totalProducts}</div>
              <div class="stat-label">Products</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card">
              <div class="stat-value">${data.totalOrders}</div>
              <div class="stat-label">Total Orders</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card">
              <div class="stat-value">${data.pendingOrders}</div>
              <div class="stat-label">Pending Orders</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card">
              <div class="stat-value">${formatCurrency(data.totalRevenue)}</div>
              <div class="stat-label">Total Revenue</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card">
              <div class="stat-value">${data.todayOrders}</div>
              <div class="stat-label">Today's Orders</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card">
              <div class="stat-value">${data.totalUsers}</div>
              <div class="stat-label">Customers</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card">
              <div class="stat-value text-warning">${data.lowStockProducts}</div>
              <div class="stat-label">Low Stock Items</div>
            </div>
          </div>
        `;
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Categories
    async function loadCategories() {
      try {
        const { data } = await api('/products/categories');
        const tbody = document.querySelector('#categoriesTable tbody');
        tbody.innerHTML = data.map(cat => `
          <tr>
            <td><img src="${cat.image || 'https://via.placeholder.com/60?text=No+Image'}" class="product-image"></td>
            <td><strong>${cat.name}</strong></td>
            <td>${cat.description || '-'}</td>
            <td>${cat._count?.products || 0}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory('${cat.id}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${cat.id}')">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function showCategoryModal(category = null) {
      document.getElementById('categoryModalTitle').textContent = category ? 'Edit Category' : 'Add Category';
      document.getElementById('categoryId').value = category?.id || '';
      document.getElementById('categoryName').value = category?.name || '';
      document.getElementById('categoryDescription').value = category?.description || '';

      categoryImageUrl = category?.image || null;
      if (categoryImageUrl) {
        document.getElementById('categoryImagePreview').classList.remove('d-none');
        document.querySelector('#categoryImagePreview img').src = categoryImageUrl;
      } else {
        document.getElementById('categoryImagePreview').classList.add('d-none');
      }

      new bootstrap.Modal(document.getElementById('categoryModal')).show();
    }

    async function editCategory(id) {
      try {
        const { data } = await api('/products/categories');
        const category = data.find(c => c.id === id);
        if (category) showCategoryModal(category);
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function handleCategoryImage(input) {
      if (input.files && input.files[0]) {
        try {
          const result = await uploadImage(input.files[0], 'categories');
          categoryImageUrl = result.data.url;
          document.getElementById('categoryImagePreview').classList.remove('d-none');
          document.querySelector('#categoryImagePreview img').src = categoryImageUrl;
          showToast('Image uploaded');
        } catch (error) {
          showToast(error.message, 'error');
        }
      }
    }

    function removeCategoryImage() {
      categoryImageUrl = null;
      document.getElementById('categoryImagePreview').classList.add('d-none');
      document.getElementById('categoryImageInput').value = '';
    }

    async function handleCategorySubmit(e) {
      e.preventDefault();
      const id = document.getElementById('categoryId').value;
      const data = {
        name: document.getElementById('categoryName').value,
        description: document.getElementById('categoryDescription').value,
        image: categoryImageUrl
      };

      try {
        if (id) {
          await api(`/admin/categories/${id}`, { method: 'PUT', body: JSON.stringify(data) });
          showToast('Category updated');
        } else {
          await api('/admin/categories', { method: 'POST', body: JSON.stringify(data) });
          showToast('Category created');
        }
        bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
        loadCategories();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteCategory(id) {
      if (!confirm('Delete this category?')) return;
      try {
        await api(`/admin/categories/${id}`, { method: 'DELETE' });
        showToast('Category deleted');
        loadCategories();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Products
    async function loadProducts() {
      try {
        // Load categories for filter
        const { data: categories } = await api('/products/categories');
        const filterSelect = document.getElementById('productCategoryFilter');
        const currentFilter = filterSelect.value;
        filterSelect.innerHTML = '<option value="">All Categories</option>' +
          categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        filterSelect.value = currentFilter;

        // Also update product form category select
        document.getElementById('productCategory').innerHTML = '<option value="">Select Category</option>' +
          categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

        // Load products
        let endpoint = '/products';
        if (currentFilter) endpoint += `?categoryId=${currentFilter}`;
        const { data: products } = await api(endpoint);

        const tbody = document.querySelector('#productsTable tbody');
        tbody.innerHTML = products.map(p => {
          const images = typeof p.images === 'string' ? JSON.parse(p.images) : (p.images || []);
          return `
            <tr>
              <td><img src="${images[0] || 'https://via.placeholder.com/60?text=No+Image'}" class="product-image"></td>
              <td><strong>${p.name}</strong><br><small class="text-muted">${p.sku}</small></td>
              <td>${p.category?.name || '-'}</td>
              <td>${formatCurrency(p.price)}/${p.unit}</td>
              <td>
                <span class="badge ${p.stock <= 10 ? 'badge-stock-low' : 'badge-stock-ok'}">
                  ${p.stock}
                </span>
              </td>
              <td>
                <span class="badge ${p.isActive ? 'bg-success' : 'bg-secondary'}">
                  ${p.isActive ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct('${p.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning me-1" onclick="toggleProduct('${p.id}')">
                  <i class="bi bi-toggle-on"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${p.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    function showProductModal(product = null) {
      document.getElementById('productModalTitle').textContent = product ? 'Edit Product' : 'Add Product';
      document.getElementById('productId').value = product?.id || '';
      document.getElementById('productName').value = product?.name || '';
      document.getElementById('productCategory').value = product?.categoryId || '';
      document.getElementById('productDescription').value = product?.description || '';
      document.getElementById('productPrice').value = product?.price || '';
      document.getElementById('productComparePrice').value = product?.comparePrice || '';
      document.getElementById('productUnit').value = product?.unit || '';
      document.getElementById('productStock').value = product?.stock || 0;
      document.getElementById('productStatus').value = product?.isActive !== false ? 'true' : 'false';

      productImages = product?.images || [];
      if (typeof productImages === 'string') productImages = JSON.parse(productImages);
      renderProductImages();

      new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    async function editProduct(id) {
      try {
        const { data } = await api(`/products/${id}`);
        showProductModal(data);
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function handleProductImages(input) {
      if (input.files) {
        for (const file of input.files) {
          if (productImages.length >= 5) {
            showToast('Maximum 5 images allowed', 'error');
            break;
          }
          try {
            const result = await uploadImage(file);
            productImages.push(result.data.url);
            renderProductImages();
          } catch (error) {
            showToast(error.message, 'error');
          }
        }
        input.value = '';
      }
    }

    function renderProductImages() {
      const container = document.getElementById('productImagesPreview');
      container.innerHTML = productImages.map((url, i) => `
        <div class="image-preview-item">
          <img src="${url}">
          <button type="button" class="remove-btn" onclick="removeProductImage(${i})">
            <i class="bi bi-x"></i>
          </button>
        </div>
      `).join('');
    }

    function removeProductImage(index) {
      productImages.splice(index, 1);
      renderProductImages();
    }

    async function handleProductSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('productId').value;
      const data = {
        name: document.getElementById('productName').value,
        categoryId: document.getElementById('productCategory').value,
        description: document.getElementById('productDescription').value,
        price: parseFloat(document.getElementById('productPrice').value),
        comparePrice: document.getElementById('productComparePrice').value ?
          parseFloat(document.getElementById('productComparePrice').value) : undefined,
        unit: document.getElementById('productUnit').value,
        stock: parseInt(document.getElementById('productStock').value),
        isActive: document.getElementById('productStatus').value === 'true',
        images: productImages
      };

      try {
        if (id) {
          await api(`/admin/products/${id}`, { method: 'PUT', body: JSON.stringify(data) });
          showToast('Product updated');
        } else {
          await api('/admin/products', { method: 'POST', body: JSON.stringify(data) });
          showToast('Product created');
        }
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        loadProducts();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function toggleProduct(id) {
      try {
        await api(`/admin/products/${id}/toggle`, { method: 'PATCH' });
        showToast('Product status updated');
        loadProducts();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Delete this product?')) return;
      try {
        await api(`/admin/products/${id}`, { method: 'DELETE' });
        showToast('Product deleted');
        loadProducts();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Orders
    async function loadOrders() {
      try {
        const status = document.getElementById('orderStatusFilter').value;
        let endpoint = '/admin/orders';
        if (status) endpoint += `?status=${status}`;

        const { data } = await api(endpoint);
        const tbody = document.querySelector('#ordersTable tbody');
        tbody.innerHTML = data.map(order => `
          <tr>
            <td><strong>#${order.orderNumber}</strong></td>
            <td>${order.user.firstName} ${order.user.lastName}<br><small>${order.user.phone}</small></td>
            <td>${order.items.length} items</td>
            <td>${formatCurrency(order.total)}</td>
            <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
            <td>${new Date(order.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="viewOrder('${order.id}')">
                <i class="bi bi-eye"></i>
              </button>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  Update
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('${order.id}', 'CONFIRMED')">Confirm</a></li>
                  <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('${order.id}', 'PROCESSING')">Processing</a></li>
                  <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('${order.id}', 'SHIPPED')">Shipped</a></li>
                  <li><a class="dropdown-item" href="#" onclick="updateOrderStatus('${order.id}', 'DELIVERED')">Delivered</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="updateOrderStatus('${order.id}', 'CANCELLED')">Cancel</a></li>
                </ul>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function viewOrder(id) {
      try {
        const { data } = await api(`/orders/${id}`);
        document.getElementById('orderDetails').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6>Order #${data.orderNumber}</h6>
              <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(data.status)}">${data.status}</span></p>
              <p><strong>Date:</strong> ${new Date(data.createdAt).toLocaleString()}</p>
            </div>
            <div class="col-md-6">
              <h6>Delivery Address</h6>
              <p>${data.deliveryAddress}</p>
            </div>
          </div>
          <hr>
          <h6>Items</h6>
          <table class="table table-sm">
            <thead>
              <tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th></tr>
            </thead>
            <tbody>
              ${data.items.map(item => `
                <tr>
                  <td>${item.product?.name || 'Product'}</td>
                  <td>${formatCurrency(item.price)}</td>
                  <td>${item.quantity}</td>
                  <td>${formatCurrency(item.price * item.quantity)}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr><td colspan="3" class="text-end"><strong>Subtotal:</strong></td><td>${formatCurrency(data.subtotal)}</td></tr>
              <tr><td colspan="3" class="text-end"><strong>Delivery:</strong></td><td>${formatCurrency(data.deliveryFee)}</td></tr>
              <tr><td colspan="3" class="text-end"><strong>Total:</strong></td><td><strong>${formatCurrency(data.total)}</strong></td></tr>
            </tfoot>
          </table>
        `;
        new bootstrap.Modal(document.getElementById('orderModal')).show();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    async function updateOrderStatus(id, status) {
      try {
        await api(`/admin/orders/${id}/status`, {
          method: 'PATCH',
          body: JSON.stringify({ status })
        });
        showToast('Order status updated');
        loadOrders();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // Helpers
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(amount || 0);
    }

    function getStatusColor(status) {
      const colors = {
        'PENDING': 'warning',
        'CONFIRMED': 'info',
        'PROCESSING': 'primary',
        'SHIPPED': 'secondary',
        'DELIVERED': 'success',
        'CANCELLED': 'danger'
      };
      return colors[status] || 'secondary';
    }
  </script>
</body>
</html>
