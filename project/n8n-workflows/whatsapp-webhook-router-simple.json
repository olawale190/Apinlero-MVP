{
  "name": "Apinlero - WhatsApp Webhook Router (Simple)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "whatsapp/webhook",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "1",
      "name": "Webhook Verify",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 200],
      "webhookId": "whatsapp-verify"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp/webhook",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "2",
      "name": "Webhook Messages",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 400],
      "webhookId": "whatsapp-messages"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query['hub.challenge'] }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "3",
      "name": "Return Challenge",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [500, 200]
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming WhatsApp message\nconst body = $input.first().json.body;\n\nif (!body || body.object !== 'whatsapp_business_account') {\n  return [{ json: { skip: true } }];\n}\n\nconst entry = body.entry?.[0];\nconst changes = entry?.changes?.[0];\nconst value = changes?.value;\n\nif (!value?.messages?.[0]) {\n  return [{ json: { skip: true } }];\n}\n\nconst message = value.messages[0];\nconst contact = value.contacts?.[0];\n\nreturn [{\n  json: {\n    phoneNumberId: value.metadata?.phone_number_id,\n    messageId: message.id,\n    from: message.from,\n    profileName: contact?.profile?.name,\n    messageType: message.type,\n    content: message.text?.body || message.interactive?.button_reply?.title || '[media]',\n    timestamp: new Date(parseInt(message.timestamp) * 1000).toISOString()\n  }\n}];"
      },
      "id": "4",
      "name": "Parse Message",
      "type": "n8n-nodes-base.code",
      "position": [500, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "1",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5",
      "name": "Skip Check",
      "type": "n8n-nodes-base.if",
      "position": [750, 400]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseCode": 200
        }
      },
      "id": "6",
      "name": "Return OK Skip",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1000, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-63e51.up.railway.app/webhook/n8n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phoneNumberId\": \"{{ $json.phoneNumberId }}\",\n  \"from\": \"{{ $json.from }}\",\n  \"profileName\": \"{{ $json.profileName }}\",\n  \"content\": \"{{ $json.content }}\",\n  \"messageType\": \"{{ $json.messageType }}\",\n  \"messageId\": \"{{ $json.messageId }}\",\n  \"timestamp\": \"{{ $json.timestamp }}\"\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "7",
      "name": "Forward to Bot",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1000, 500]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {
          "responseCode": 200
        }
      },
      "id": "8",
      "name": "Return OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 500]
    }
  ],
  "connections": {
    "Webhook Verify": {
      "main": [
        [
          {
            "node": "Return Challenge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Messages": {
      "main": [
        [
          {
            "node": "Parse Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Message": {
      "main": [
        [
          {
            "node": "Skip Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Check": {
      "main": [
        [
          {
            "node": "Return OK Skip",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Forward to Bot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Forward to Bot": {
      "main": [
        [
          {
            "node": "Return OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
