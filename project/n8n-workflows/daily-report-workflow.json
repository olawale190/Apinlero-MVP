{
  "name": "Apinlero - Daily Business Report",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "triggerAtHour": 18
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Daily 6 PM Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [250, 300],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "orders",
        "returnAll": true,
        "filterByFormula": "created_at >= current_date"
      },
      "id": "get-todays-orders",
      "name": "Get Today's Orders",
      "type": "n8n-nodes-base.supabase",
      "position": [500, 200],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "products",
        "returnAll": true,
        "filterByFormula": "stock_quantity <= min_stock_level"
      },
      "id": "get-low-stock",
      "name": "Get Low Stock Items",
      "type": "n8n-nodes-base.supabase",
      "position": [500, 400],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Compile daily report\nconst orders = $('Get Today\\'s Orders').all();\nconst lowStock = $('Get Low Stock Items').all();\n\nconst today = new Date().toLocaleDateString('en-GB', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\n// Calculate metrics\nconst totalOrders = orders.length;\nconst totalRevenue = orders.reduce((sum, o) => sum + parseFloat(o.json.total || 0), 0);\nconst pendingOrders = orders.filter(o => o.json.status === 'Pending').length;\nconst confirmedOrders = orders.filter(o => o.json.status === 'Confirmed').length;\nconst deliveredOrders = orders.filter(o => o.json.status === 'Delivered').length;\n\n// Orders by channel\nconst byChannel = {};\norders.forEach(o => {\n  const channel = o.json.channel || 'Unknown';\n  byChannel[channel] = (byChannel[channel] || 0) + 1;\n});\n\n// Low stock summary\nconst lowStockItems = lowStock.map(p => ({\n  name: p.json.name,\n  current: p.json.stock_quantity,\n  minimum: p.json.min_stock_level\n}));\n\n// Build report\nconst report = {\n  date: today,\n  summary: {\n    totalOrders,\n    totalRevenue: totalRevenue.toFixed(2),\n    pendingOrders,\n    confirmedOrders,\n    deliveredOrders\n  },\n  ordersByChannel: byChannel,\n  lowStockCount: lowStockItems.length,\n  lowStockItems: lowStockItems.slice(0, 10),\n  generatedAt: new Date().toISOString()\n};\n\n// Format email body\nconst emailBody = `\nðŸ“Š Daily Business Report - ${today}\n\nðŸ“¦ ORDERS\nâ€¢ Total Orders: ${totalOrders}\nâ€¢ Revenue: Â£${totalRevenue.toFixed(2)}\nâ€¢ Pending: ${pendingOrders}\nâ€¢ Confirmed: ${confirmedOrders}\nâ€¢ Delivered: ${deliveredOrders}\n\nðŸ“± BY CHANNEL\n${Object.entries(byChannel).map(([k, v]) => `â€¢ ${k}: ${v}`).join('\\n')}\n\nâš ï¸ LOW STOCK ALERTS (${lowStockItems.length} items)\n${lowStockItems.slice(0, 5).map(i => `â€¢ ${i.name}: ${i.current}/${i.minimum}`).join('\\n') || 'No low stock items'}\n\n---\nGenerated by Apinlero at ${new Date().toLocaleTimeString('en-GB')}\n`;\n\nreturn [{\n  json: {\n    ...report,\n    emailSubject: `ðŸ“Š Daily Report - ${today} - ${totalOrders} orders, Â£${totalRevenue.toFixed(2)}`,\n    emailBody\n  }\n}];"
      },
      "id": "compile-report",
      "name": "Compile Report",
      "type": "n8n-nodes-base.code",
      "position": [800, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "daily_reports",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "report_date": "={{ $now.format('yyyy-MM-dd') }}",
            "total_orders": "={{ $json.summary.totalOrders }}",
            "total_revenue": "={{ $json.summary.totalRevenue }}",
            "orders_by_channel": "={{ JSON.stringify($json.ordersByChannel) }}",
            "low_stock_count": "={{ $json.lowStockCount }}",
            "report_data": "={{ JSON.stringify($json) }}"
          }
        }
      },
      "id": "save-report",
      "name": "Save Report to DB",
      "type": "n8n-nodes-base.supabase",
      "position": [1050, 200],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "reports@apinlero.com",
        "toEmail": "={{ $env.OWNER_EMAIL || 'owner@example.com' }}",
        "subject": "={{ $json.emailSubject }}",
        "text": "={{ $json.emailBody }}"
      },
      "id": "send-email",
      "name": "Send Email Report",
      "type": "n8n-nodes-base.emailSend",
      "position": [1050, 400],
      "credentials": {
        "smtp": {
          "id": "SMTP_CREDENTIAL_ID",
          "name": "SMTP"
        }
      }
    }
  ],
  "connections": {
    "Daily 6 PM Trigger": {
      "main": [
        [
          {
            "node": "Get Today's Orders",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Low Stock Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Today's Orders": {
      "main": [
        [
          {
            "node": "Compile Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Low Stock Items": {
      "main": [
        [
          {
            "node": "Compile Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compile Report": {
      "main": [
        [
          {
            "node": "Save Report to DB",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Email Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "timezone": "Europe/London"
  },
  "tags": [
    "apinlero",
    "reporting",
    "daily",
    "scheduled"
  ]
}
