// Prisma Schema for Apinlero MVP
// Using PostgreSQL with secure defaults

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with security best practices
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   @map("password_hash") // Never store plain passwords
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  role          Role     @default(USER)
  isActive      Boolean  @default(true) @map("is_active")
  isVerified    Boolean  @default(false) @map("is_verified")

  // Security fields
  failedLoginAttempts Int      @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  lastLoginAt         DateTime? @map("last_login_at")
  lastLoginIp         String?   @map("last_login_ip")

  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  refreshTokens RefreshToken[]
  apiKeys       ApiKey[]
  auditLogs     AuditLog[]

  @@map("users")
  @@index([email])
}

// Refresh tokens for secure JWT rotation
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Security: track token usage
  lastUsedAt DateTime? @map("last_used_at")
  userAgent  String?   @map("user_agent")
  ipAddress  String?   @map("ip_address")

  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
}

// API Keys for programmatic access
model ApiKey {
  id          String    @id @default(cuid())
  name        String
  keyHash     String    @unique @map("key_hash") // Store hashed, not plain
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions String[]  // Array of permission strings
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("api_keys")
  @@index([userId])
}

// Audit log for security monitoring
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String   // e.g., "LOGIN", "LOGOUT", "PASSWORD_CHANGE"
  resource  String?  // e.g., "user", "api_key"
  resourceId String? @map("resource_id")
  details   Json?    // Additional context
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  success   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}
